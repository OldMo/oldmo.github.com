---
layout: post
title: "tomcat频繁重启错误"
description: ""
category: IT在路上
tags: [系统开发]
---

2012年岁末接了一个项目，时间紧，没有过多的测试，匆匆做好就急忙上线，项目虽然不复杂，但是问题不断，将其中一个最头疼的问题记录如下，问题报错日志在tomcat根目录下，我的日志名字是 **hs_err_pid3164.log**，具体的情况如下描述：

好吧，我表示我要写点什么东西了，虽然这破项目还是问题不断，依旧令我揪心补不已，提心吊胆，对手机和QQ都非常敏感，就怕有人联系我说出现问题，但是至少把一个大问题解决了，一个困扰了我好几天，一直找不到头绪，令我连死了的心都有的问题。    
问题发生在给学校的招生部门开发一个招生网站上，网站涉及的东西很少，数据处理也不多，都是一些基本的更新和读取功能，还有一个图片上传，网站的访问量也不是很大，同时在线最多也就是八十人这样子，考虑到网站规模比较小，同时如果使用其他数据库还要在服务器上面安装，比较麻烦，为了简单起见 决定选择access作为数据库，用struts2的框架做开发。开发时间很紧，一个星期内赶出了初版，稍微根据需求又改了一下后也没有完整的测试，就上线了，感觉松了一大口气。可是网站才刚上线一天就出现问题了……第二天还没睡醒，老师紧急打电话说网站挂掉了，尼玛这个不得了了，管理服务器的老师看了之后说，可能是tomcat的配置问题，我用的是默认配置，在实际应用中可能人比较多就挂掉了，还有一个就是程序报错比较多，主要是上传的一块出错。  
刚开始就以为是tomcat配置文件的问题，于是就开始修改配置文件，把网站的连接数设置的比较大，把内存也分配的足够大，之前还没发现竟然可以通过tomcat的主页的statu那里监测网站的运行情况，包括连接数，使用内存等。晚上在网站使用人数较少时，把这些都配置好了，以为一切都顺利了，可是，第二天还在睡梦中又被叫醒说网站又挂掉了，一看发现tomcat又当掉了，赶紧起来重启tomcat。开始找这个问题的所在，百度和google了很多关于tomcat崩溃的信息，很多都说是连接数和内存的问题，可是我改了还是有依旧错，一整天都在找问题，期间开始知道可以监测网站信息，发现同时在线的人不多，内存足够，面对问题素手无策，只能整天随时连着服务器，网站一挂就计立刻手动重启，真是寝食难安啊！晚上又是熬得很晚找问题，以为是tomcat问题，换了tomcat7.0,期望一切能变好，可是第二天还是被叫醒，网站又挂了，又赶紧起来搞，但是无从下手，搜索出来的还是那些解决方案，对我的都没有效。  
决定请教老师，看有没有方法解决，听了老师的建议决定把程序优化一下：一个是上传中读取图片路径无法找到导致流异常关闭，以为是这里内存泄露导致服务器挂掉。把这个解决了，上传时不再报错；同时将数据库的statement语句换了preparedstatement， 重新设置了查询语句，以为是sql注入问题。这两个都进行了修改，晚上熬得很晚将这些进行替换掉，心想终于搞好了，可是第二天还是再次挂掉了，连死了的心都有啊，身边无人能帮忙，只能靠自己，因为不知道是什么问题导致的这种情况，他们说得没错，不怕不能解决问题，而是怕找不到问题。到这个时候，确实是无从下手了，网站停掉的时间段很奇怪，有时候可以有五六个小时，有时候几分钟就停了，很无奈，又得每时每刻都守着，随时准备手动重启，心力交瘁，连去吃个饭都不安心，同时随时都怕电话响起来反馈网站问题，那时候确实很累。  
后来没有办法，只能先解决tomcat挂掉后自动启动问题，至少可以安心一些去问题，找到一个tomcat死机监测工具，这个工具可以每隔一段时间扫描一下tomcat是否启动了，暂时可以这么混过去了，至少可以不用自己手动重启，不用随时都守着了，缓了一口气。但是心里还是不踏实的，问题总归还是在那里，还是回心绪不宁，看着tomcat每天竟然重启多达十几次，这是令人无法接受的。于是还是不断的翻看日志，主要还是看logs文件夹中的日志文件，某天突然在tomcat根目录下看到也有一堆日志文件，每天都有生成，打开之后发现报错信息如下，


<p style="color:red">An unexpected error has been detected by Java Runtime Environment:

EXCEPTION_ACCESS_VIOLATION (0xc0000005) at pc=0x7c94a1c1, pid=5944, tid=4400

 Java VM: Java HotSpot(TM) Client VM (11.0-b15 mixed mode windows-x86)
 Problematic frame:
 C  [ntdll.dll+0x1a1c1]
…..
Heap  
 def new generation   total 18240K, used 3156K [0×03060000, 0×04420000, 0x07f20000)  
  eden space 16256K,  19% used [0×03060000, 0×03375280, 0×04040000)  
  from space 1984K,   0% used [0×04230000, 0×04230000, 0×04420000)  
  to   space 1984K,   0% used [0×04040000, 0×04040000, 0×04230000)  
 tenured generation   total 241984K, used 28662K [0x07f20000, 0x16b70000, 0×43060000)  
   the space 241984K,  11% used [0x07f20000, 0x09b1d8d8, 0x09b1da00, 0x16b70000)  
 compacting perm gen  total 19456K, used 19362K [0×43060000, 0×44360000, 0×47060000)  
   the space 19456K,  99% used [0×43060000, 0x443488d0, 0x44348a00, 0×44360000)
No shared spaces configured.  
</p>
感觉问题就是出现在这里了，终于，快找到问题了，根据这个信息网上查找了一下，说是jdk的bug，使用时会出现内存访问异常，于是更新了新的jdk,第二天确依然如此，让人很无奈，难道这个还不是最终的问题所在？很是失望，可是没有办法，还是得继续查找，终于发现有人提到说是jdbc,odbc使用access作为数据库时是存在bug的，access一般只作为测试使用，不作为正式用途，不然会出错，导致异常问题。好像jdk1.7是修复了这个问题了，下了想试一下的，可是用了之后tomcat启动不了，算了，不想再试了，决定直接换数据库，期间还发生了一些异常，这里产生的问题又另叙了，换好了之后网站终于是不挂了，算是把这个问题给解决了，终于舒了一口气。唉， 只是为了不想有前面装数据库的麻烦，竟然给自己招惹了这么多的不痛快，劳心劳力啊！！所以说工具是选择很重要，access啊，不堪大用啊！同时提醒自己，问题无处不在，要找对问题才是关键！
